# 一、js的单线程模型

js同一时间只能在一个线程（主线程）执行，并不是说js引擎只有一个线程。
js采用单线程有其历史原因，因为不想做的太复杂。
多线程涉及到资源共享、可能对一个对象同时操作导致冲突，加锁机制等等。

好处是实现简单，问题是如果一个任务耗时过长，后面的任务排队等着，造成严重的延时，比如浏览器无响应。
js本身并不慢，慢的是IO，网络，比如读写外部文件，网络请求和响应。

如果运算量大，CPU正忙也就算了，但大部分时间，CPU处于空闲状态。
js语言的设计者意识到，可以把耗时的IO任务先挂起，先执行后面的简单任务，
等IO任务执行完成返回结果，再把挂起的任务继续。
这种机制就是“事件循环” Event Loop

现在的CPU大多数都是多核的，那如何利用多核能力呢？
HTML5提出Web Worker标准，允许js创建多个线程，但子线程完全受主线程控制，且不能操作DOM。

**那如何知道哪些任务需要挂起，哪些可以顺序执行呢？**
程序里任务分为：同步任务和异步任务
同步任务是在主线顺序执行的任务，后面的任务必须等前面的执行完才轮到，
异步任务是先挂起，不进入主线程，而进入任务队列的任务。
排在异步任务后面的代码不必等待其结束就可以执行，异步任务具有“不阻塞”的效应。

**实际上，根据异步任务的类型，队列有多个。**

**执行顺序**
同步任务 -> 任务队列（有符合的任务就通过函数调用进入主线程执行，进入主线程后就变成同步任务了）

异步任务的写法通常是回调函数。一旦异步任务进入主线程，就会执行对应的回调函数。
如果没有回调函数，就不会进入任务队列。

**js引擎怎么知道异步任务有没有结果，能不能进入主线程？**
答案是引擎会不停的检查，看同步任务是否全部执行完，
然后去检查那些挂起的异步任务，是不是可以执行。
这种循环检查的机制就是事件循环。
维基百科的定义：事件循环是一个程序结构，用于等待和发送消息和事件。

## 异步操作的模式

###  回调函数，
好处：简单，容易理解和实现
缺点：不利于代码阅读和维护，各个部分高度耦合（coupling）
```
function f1(){
}
function f2(){
}
f1()
f2()
// 本意是先执行f1，再执行f2。
// 如果f1是异步操作，f2会立即执行
// 可以改成回调函数的形式

function f1(callback){
  ...
  callback();
}
function f2() {
}
f1(f2)
```

### 事件监听

这种思路是事件驱动模式，异步任务的执行不取决于代码的顺序，而是取决于
某个事件是否发生。

```
f1.on('done', f2)
```
上面代码表示，当f1发生done事件，就执行f2。
```
function f1() {
  setTimeout(function() {
    f1.trigger('done');
  },0)
}
```
好处：去耦合，有利于实现模块化
缺点：流程不清晰，不利于阅读

### 发布/订阅模式（又称观察者模式）

事件可以看作“信号”，如果存在一个信号中心，某个任务执行完成，就向信号中心发布一个信号，
其他任务可以向信号中心“订阅”这个信号，从而知道什么时候可以执行。

这个模式有多种实现，比如
```
// f2向信号中心$订阅done信号
$.subscribe('done', f2);

// f1执行完，向信号中心发布done信号，从而引发f2的执行。
function f1() {
  // ...
  setTimeout(function() {
    $.publish('done');
  }, 1000)
}

// f2执行完，可以取消订阅
$.unsubscribe('done', f2);
```

这种模式可以和事件监听类似，但后者是分散的，不利于管理和维护。
而前者是有一个中心，可以集中管理，便于控制程序的运行。

## 异步操作的流程控制

回调嵌套
```
function async(arg, callback) {
  console.log(arg);
  setTimeout(function() {
    callback()
  },1000)
}

function final() {
  
}

async(1, function() {
  async(2, function() {
    async(3, function() {
      async(4, final);
    })
  })
})
```


串行：类似把异步同步化

并行：同时执行，时间短，运算密集

串行并行结合：控制并行的数量，分组串行

--------------------------------------------------

# 定时器





